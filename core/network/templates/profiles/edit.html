{% extends "network/layout.html" %}

{% load form_filters %}

{% block body %}
<div class="min-h-screen bg-amber-50 p-4"
     style="background-image: url('data:image/svg+xml,%3Csvg%20width%3D%2220%22%20height%3D%2220%22%20viewBox%3D%220%200%2020%2020%22%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%3E%3Crect%20width%3D%2220%22%20height%3D%2220%22%20fill%3D%22%23F59E0B%22%20opacity%3D%220.05%22/%3E%3Crect%20width%3D%2210%22%20height%3D%2210%22%20fill%3D%22%23D97706%22%20opacity%3D%220.1%22/%3E%3C/svg%3E');
     "
     x-data="profileEditor()"
     >  
  <!-- Turtle Header -->
  <div class="max-w-2xl mx-auto mb-8">
    <div class="bg-green-800 border-4 border-green-900 rounded-lg p-6 font-mono text-center relative overflow-hidden">
      <!-- Pixel decorations -->
      <div class="absolute top-2 left-2 w-3 h-3 bg-green-600 border border-green-900"></div>
      <div class="absolute top-2 right-2 w-3 h-3 bg-green-600 border border-green-900"></div>
      <div class="absolute bottom-2 left-2 w-3 h-3 bg-green-600 border border-green-900"></div>
      <div class="absolute bottom-2 right-2 w-3 h-3 bg-green-600 border border-green-900"></div>
      
      <h1 class="text-2xl font-bold text-green-100 mb-2">TURTLE PROFILE EDITOR</h1>
      <p class="text-green-200 text-sm">Customize your shell and personality!</p>
    </div>
  </div>

  <!-- Main Form Container -->
  <div class="max-w-2xl mx-auto" >
    <form method="post" 
          action="{% url 'profile_edit' %}" 
          enctype="multipart/form-data" 
          class="bg-green-700 border-4 border-green-900 rounded-lg p-8 font-mono shadow-xl">
      {% csrf_token %}

      <!-- Profile Picture Section -->
      <div class="mb-8">
        <div class="flex items-center gap-2 mb-4">
          <div class="w-4 h-4 bg-green-500 border-2 border-green-900"></div>
          <label class="text-lg font-bold text-green-100">TURTLE AVATAR</label>
        </div>
        
        <div class="bg-green-600 border-2 border-green-800 rounded p-6">
          <!-- Current Picture Display -->
          {% if user.profile.profile_picture %}
          <div class="mb-4 text-center">
            <div class="inline-block bg-amber-100 border-4 border-green-900 p-2 rounded">
              <img src="{{ user.profile.profile_picture.url }}"
                   alt="Current Turtle Avatar"
                   class="w-24 h-24 object-cover border-2 border-green-800 rounded pixelated"
                   style="image-rendering: pixelated;">
            </div>
            <p class="text-green-100 text-sm mt-2">Current Shell Design</p>
          </div>
          {% endif %}

          <!-- File Upload Area -->
          <div class="relative">
            <div class="border-4 border-dashed border-green-400 rounded-lg p-8 text-center bg-green-500 hover:bg-green-400 transition-colors cursor-pointer"
                 @click="$refs.fileInput.click()"
                 @dragover.prevent="isDragging = true"
                 @dragleave="isDragging = false"
                 @drop.prevent="handleFileDrop($event)"
                 :class="isDragging ? 'border-amber-400 bg-amber-200' : ''"
                 x-ref="dropZone">
              
              <div class="text-6xl mb-2" x-show="!previewImage">üê¢</div>
              <div class="text-green-900 font-bold mb-2" x-show="!previewImage">
                DROP YOUR SHELL HERE!
              </div>
              <div class="text-green-800 text-sm mb-4" x-show="!previewImage">
                Or click to browse files
              </div>
              
              <!-- Preview Image -->
              <div x-show="previewImage" class="mb-4">
                <img :src="previewImage" 
                     class="w-32 h-32 object-cover border-4 border-green-900 rounded mx-auto pixelated"
                     style="image-rendering: pixelated;">
                <p class="text-green-900 text-sm mt-2 font-bold">New Shell Preview!</p>
              </div>
              
              <input type="file" 
                     accept="image/*" 
                     name="profile_picture" 
                     class="hidden"
                     id="id_profile_picture"
                     @change="handleFileSelect($event)"
                     x-ref="fileInput">
            </div>
            
            <!-- File Input Styled Button -->
            <div class="mt-4 text-center">
              <button type="button"
                      @click="$refs.fileInput.click()"
                      class="bg-amber-500 hover:bg-amber-400 border-4 border-amber-700 text-amber-900 font-bold py-2 px-6 rounded text-sm transition-colors">
                üìÅ BROWSE SHELL FILES
              </button>
            </div>
          </div>
          
          <!-- Error Display -->
          <div class="mt-4" x-show="Object.keys(errors).length > 0">
            {{ form.profile_picture.errors }}
          </div>
        </div>
      </div>

      <!-- Personal Info Grid -->
      <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
        
        <!-- Username -->
        <div>
          <div class="flex items-center gap-2 mb-2">
            <div class="w-3 h-3 bg-amber-500 border border-amber-700"></div>
            <label for="id_username" class="text-green-100 font-bold text-sm">TURTLE NAME</label>
          </div>
          <input type="text" 
                 name="username" 
                 class="w-full bg-green-600 border-2 border-green-800 rounded px-4 py-3 text-green-100 font-mono placeholder-green-300 focus:border-amber-400 focus:outline-none transition-colors"
                 id="id_username" 
                 value="{{ form.username.value|default_if_none:'' }}"
                 placeholder="Enter your turtle name...">
          <div class="text-red-300 text-xs mt-1">{{ form.username.errors }}</div>
        </div>

        <!-- First Name -->
        <div>
          <div class="flex items-center gap-2 mb-2">
            <div class="w-3 h-3 bg-amber-500 border border-amber-700"></div>
            <label for="id_first_name" class="text-green-100 font-bold text-sm">FIRST SHELL</label>
          </div>
          <input type="text" 
                 name="first_name" 
                 class="w-full bg-green-600 border-2 border-green-800 rounded px-4 py-3 text-green-100 font-mono placeholder-green-300 focus:border-amber-400 focus:outline-none transition-colors"
                 id="id_first_name" 
                 value="{{ form.first_name.value|default_if_none:'' }}"
                 placeholder="First name...">
          <div class="text-red-300 text-xs mt-1">{{ form.first_name.errors }}</div>
        </div>

        <!-- Last Name -->
        <div>
          <div class="flex items-center gap-2 mb-2">
            <div class="w-3 h-3 bg-amber-500 border border-amber-700"></div>
            <label for="id_last_name" class="text-green-100 font-bold text-sm">FAMILY SHELL</label>
          </div>
          <input type="text" 
                 name="last_name" 
                 class="w-full bg-green-600 border-2 border-green-800 rounded px-4 py-3 text-green-100 font-mono placeholder-green-300 focus:border-amber-400 focus:outline-none transition-colors"
                 id="id_last_name" 
                 value="{{ form.last_name.value|default_if_none:'' }}"
                 placeholder="Last name...">
          <div class="text-red-300 text-xs mt-1">{{ form.last_name.errors }}</div>
        </div>

        <!-- Phone Number -->
        <div>
          <div class="flex items-center gap-2 mb-2">
            <div class="w-3 h-3 bg-amber-500 border border-amber-700"></div>
            <label for="id_phonenumber" class="text-green-100 font-bold text-sm">SHELL PHONE</label>
          </div>
          <div class="relative">
            {{ form.phonenumber|add_class:"w-full bg-green-600 border-2 border-green-800 rounded px-4 py-3 text-green-100 font-mono placeholder-green-300 focus:border-amber-400 focus:outline-none transition-colors" }}
            <div class="absolute right-3 top-3 text-green-300">üìû</div>
          </div>
          <div class="text-red-300 text-xs mt-1">{{ form.phonenumber.errors }}</div>
        </div>
      </div>

      <!-- Birth Date -->
      <div class="mb-8">
        <div class="flex items-center gap-2 mb-2">
          <div class="w-3 h-3 bg-amber-500 border border-amber-700"></div>
          <label for="id_birth_date" class="text-green-100 font-bold text-sm">SHELL BIRTHDAY</label>
        </div>
        <div class="relative">
          {{ form.birth_date|add_class:"w-full bg-green-600 border-2 border-green-800 rounded px-4 py-3 text-green-100 font-mono focus:border-amber-400 focus:outline-none transition-colors" }}
          <div class="absolute right-3 top-3 text-green-300">üéÇ</div>
        </div>
        <div class="text-red-300 text-xs mt-1">{{ form.birth_date.errors }}</div>
      </div>

      <!-- Bio Section -->
      <div class="mb-8">
        <div class="flex items-center gap-2 mb-2">
          <div class="w-3 h-3 bg-amber-500 border border-amber-700"></div>
          <label for="id_bio" class="text-green-100 font-bold text-sm">TURTLE STORY</label>
          <div class="ml-auto text-green-300 text-xs" x-text="bioLength + '/280 characters'"></div>
        </div>
        <div class="relative">
          <textarea name="bio" 
                    class="w-full bg-green-600 border-2 border-green-800 rounded px-4 py-3 text-green-100 font-mono placeholder-green-300 focus:border-amber-400 focus:outline-none transition-colors resize-none"
                    id="id_bio"
                    rows="4"
                    maxlength="280"
                    placeholder="Tell the world about your turtle adventures..."
                    x-model="bio"
                    @input="bioLength = $event.target.value.length">{{ form.bio.value|default_if_none:'' }}</textarea>
          
          <!-- Character Count Visual -->
          <div class="mt-2 h-2 bg-green-800 rounded border border-green-900">
            <div class="h-full bg-gradient-to-r from-green-400 to-amber-500 rounded transition-all duration-300"
                 :style="{ width: (bioLength / 280) * 100 + '%' }"
                 :class="bioLength > 250 ? 'from-amber-400 to-red-500' : 'from-green-400 to-amber-500'"></div>
          </div>
        </div>
        <div class="text-red-300 text-xs mt-1">{{ form.bio.errors }}</div>
      </div>

      <!-- Submit Button -->
      <div class="text-center">
        <button type="submit" 
                class="bg-amber-500 hover:bg-amber-400 active:bg-amber-600 border-4 border-amber-700 hover:border-amber-600 text-amber-900 font-bold py-4 px-12 rounded-lg text-lg transition-all duration-200 transform hover:scale-105 active:scale-95"
                :disabled="isSubmitting"
                x-text="isSubmitting ? 'üê¢ UPDATING SHELL...' : 'üíæ SAVE TURTLE PROFILE'">
        </button>
        
        <p class="text-green-200 text-xs mt-4">
          üåø Your turtle profile will be updated immediately
        </p>
      </div>
    </form>
  </div>
  
  <!-- Success Message -->
  <div x-show="showSuccess" 
       x-cloak
       x-init="hideSuccessMessage()"
       class="fixed top-8 right-8 bg-green-500 border-4 border-green-700 rounded-lg p-4 text-green-900 font-mono font-bold shadow-xl z-50">
    üéâ Turtle profile updated successfully! üê¢
  </div>

</div>
<script>
  function profileEditor() {
    return {
      isDragging: false,
      previewImage: null,
      bio: '{{ form.bio.value|default_if_none:"" }}',
      bioLength: '{{ form.bio.value|default_if_none:""|length }}',
      errors: {},
      isSubmitting: false,
      showSuccess: {{ edited_success|yesno:'true, false' }},

      hideSuccessMessage() {
        if(this.showSuccess) setTimeout(() => { this.showSuccess = false; }, 3000)
      },

      handleFileSelect(event) {
        const file = event.target.files[0];
        if (file) {
          this.previewFile(file);
        }
      },

      handleFileDrop(event) {
        this.isDragging = false;
        const files = event.dataTransfer.files;
        if (files.length > 0) {
          const file = files[0];
          if (file.type.startsWith('image/')) {
            // Update the file input
            const fileInput = this.$refs.fileInput;
            const dt = new DataTransfer();
            dt.items.add(file);
            fileInput.files = dt.files;
            
            this.previewFile(file);
          }
        }
      },

      previewFile(file) {
        if (file && file.type.startsWith('image/')) {
          const reader = new FileReader();
          reader.onload = (e) => {
            this.previewImage = e.target.result;
          };
          reader.readAsDataURL(file);
        }
      },

      init() {
        // Initialize bio length
        this.bioLength = parseInt('{{ form.bio.value|default_if_none:""|length }}') || 0;
      }
    }
  }

  // Add pixelated rendering style
  document.addEventListener('DOMContentLoaded', function() {
    const style = document.createElement('style');
    style.textContent = `
      .pixelated {
        image-rendering: -moz-crisp-edges;
        image-rendering: -webkit-crisp-edges;
        image-rendering: pixelated;
        image-rendering: crisp-edges;
      }
    `;
    document.head.appendChild(style);
  });
</script>

{% endblock %}
