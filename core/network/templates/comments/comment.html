{% load post_extra %}
<div 
    id="comment-{{ comment.id }}"
    x-data="{ 
        isHovering: false, 
        editing: false, 
        replying: false,
        commentBody: '{{ comment.content|escapejs }}',
        newComment: {{ is_new_comment|yesno:'true,false' }}, 
        isOwner: {% if request.user == comment.user%}true{% else %}false{%endif%},
        setReplyTo() { return this.isOwner ? '' : '@{{ comment.username }} ' },
        liked: {{ comment|liked_by_user:request.user|yesno:'true,false' }},
        likeCount: {{ comment.like_count }},

        collapse: true,
        showMore: false,
        checkClamp() {
            const content = this.$refs.content;
            this.showMore = content.scrollHeight > content.clientHeight;
        },
        deleteComment() {
          $el.remove();
        },
        init() {
            $nextTick(() => this.checkClamp());
        },
    }">
    <div 
        class="flex w-full mb-2"
        @mouseover="isHovering = true"
        @mouseleave="isHovering = false"
        >
        <!-- Profile picture -->
        <a class="min-w-11 holo-avatar-link" href="{% url 'profile_about' comment.username  %}">
            <img 
            src="{{ comment.profile_picture_url }}" 
            class="holo-comment-avatar rounded-full w-11 h-11 object-cover me-2 transition-all duration-300" 
            alt="profile picture"
            style="image-rendering: pixelated;">
        </a>
        
        <!-- Comment  -->
        <div x-show="!editing" class="min-w-0 wrap-break-word">   
            <!-- Username and collapsable content -->
            <div
                x-effect="if(newComment) $nextTick(() => newComment = false)"
                :class="newComment ? 'holo-comment-new' : 'holo-comment-shell'"
                class="rounded-lg px-4 py-3 transition-all duration-5000 relative overflow-hidden"
                @mouseover="$el.classList.add('holo-comment-hover')"
                @mouseleave="$el.classList.remove('holo-comment-hover')">
                <strong class="holo-username">{{ comment.username }}</strong>
                <p 
                    class="mb-1 holo-comment-text"
                    x-ref="content"
                    style="max-width: 20rem;"
                    :class="collapse && 'line-clamp-2'"
                    >{{ comment.content|linebreaksbr }}
                </p>
                {% include 'common/collapse.html' %}
            </div>
            <!-- Time, like & Reply button -->
            <div class="flex justify-between mb-1">
              <div class="flex self-center">
                  <small class="p-0 me-2" style="color: rgba(255, 255, 255, 0.8);">{{ comment.created_at|timesince_simple }}</small>

                  <small 
                    class="p-0 me-2 cursor-pointer hover:underline"
                    x-text="liked ? 'Liked' : 'Like'"
                    :class="liked && 'text-green-400 fw-bold'"
                    {% if request.user.is_authenticated %}
                      hx-post="{% url 'comment_like' comment.id %}"
                      hx-target="#comment-like-count-{{ comment.id }}"
                      hx-swap="outerHTML"
                    {% else %}
                      hx-get="{% url 'account_login' %}"
                      hx-target="#modal-container"
                      hx-select="#auth-modal-content"
                      @htmx:after-request="if($event.detail.successful) showModal = true;"
                    {% endif %}>Like</small>
  
                  <small 
                    class="p-0 me-2 cursor-pointer hover:underline"
                    style="color: rgba(255, 255, 255, 0.8);"
                  {% if request.user.is_authenticated %}
                    @click="replying = true"
                  {% else %}
                    hx-get="{% url 'account_login' %}"
                    hx-target="#modal-container"
                    hx-select="#auth-modal-content"
                    @htmx:after-request="if($event.detail.successful) showModal = true;"
                  {% endif %}
                  >Reply</small>
              </div>

              <div class="flex self-center" x-show="likeCount > 0">
                  <span 
                    id="comment-like-count-{{ comment.id }}"
                    class="fw-bold"
                    x-text="likeCount"
                  ></span> 

                  <img 
                    class="w-5 h-auto mx-2" 
                    src="/media/defaults/thumbsup.png" 
                    alt="Turtle Thumbsup Image"
                  >
              </div>
            </div>

        </div>

        <!-- Comment 3-dot menu -->
        {% if request.user == comment.user %}
            <div class="text-white" x-show="isHovering && !editing" x-transition>
                {% include 'comments/dropdown.html' %}
            </div>
        {% endif %}

        <!-- Edit form (initially hidden) -->
        <form 
            class="flex-grow-1" 
            hx-post="{% url 'comment_edit' comment.id %}"
            hx-target="#comment-{{ comment.id }}"
            hx-swap="outerHTML"
            hx-select-oob="#comment-{{ comment.id }}"
            x-show="editing"
            x-effect="if(editing) $focus.first()"
            x-cloak
            @htmx:before-request="preventEmptySubmit($event)"
            >
                {% include 'comments/submit.html' with for_comment_submit=True %}
            <a 
                class="btn link-primary link-opacity-50-hover text-decoration-none font-bold mt-2 ms-2" 
                @click="editing = false">Cancel</a>

        </form>
    </div>

    <!-- Children replies (Dynamically fetched) -->
    <div id="replies-wrapper-{{ comment.id }}">
      <div 
        class="ps-5"
        :id=" isPostDetail ? 'post-detail-replies-{{ comment.id }}' : 'post-list-replies-{{ comment.id }}'"
        ></div>
    </div>
    <!-- TODO Make show more display dynamically using alpine js -->
    <!-- Show more reply button  -->
    {% if comment.children_count %}
    <div 
        class="btn btn-sm text-muted ps-5 mb-3"
        @click="$nextTick(() => $el.remove())"
        hx-get="{% url 'comment_children' comment.id %}"
        hx-swap="innerHTML"
        :hx-target="isPostDetail ? '#post-detail-replies-{{ comment.id }}' : '#post-list-replies-{{ comment.id }}'"
      >See other {{ comment.children_count }} repl{{ comment.children_count|pluralize:'y,ies' }}
    </div>
    {% endif %}

    <!-- Reply form (initially hidden) -->
    <form 
        class="ps-5 mb-3" 
        x-data="{ commentBody: setReplyTo() }"
        x-show="replying"
        x-cloak
        x-effect="if(replying) {commentBody = setReplyTo(); $focus.first() }"
        @htmx:before-request="preventEmptySubmit($event)"
        @htmx:after-request="if($event.detail.successful) clearUpForm($el)"
        hx-post="{% url 'comment_create' comment.post.id %}"
        hx-vals='{ "is_reply": true }'
        hx-swap="beforeend"
        :hx-target="isPostDetail ? '#post-detail-replies-{{ comment.id }}' : '#post-list-replies-{{ comment.id }}'"
    >
        <!-- Comment submit textarea -->
        {% include 'comments/submit.html' %}
        <!-- Parent comment input -->
        <input type="hidden" name="parent_id" value="{{ comment.id }}">
        <a 
            class="btn link-primary link-opacity-50-hover text-decoration-none mt-2 ms-2" 
            @click="replying = false">Cancel</a>
    </form>
</div>

<style>
/* Holographic Comment Shells */


.holo-comment-shell {
    background: rgba(255, 255, 255, 0.08);
    border: 1px solid rgba(6, 182, 212, 0.3);
    backdrop-filter: blur(15px);
    box-shadow: 
        0 8px 16px rgba(0, 0, 0, 0.1),
        inset 0 1px 2px rgba(255, 255, 255, 0.05);
}

.holo-comment-new {
    background: rgba(6, 182, 212, 0.12);
    border: 1px solid rgba(6, 182, 212, 0.4);
    backdrop-filter: blur(15px);
    box-shadow: 
        0 8px 16px rgba(6, 182, 212, 0.2),
        0 0 30px rgba(6, 182, 212, 0.15),
        inset 0 1px 2px rgba(255, 255, 255, 0.1);
}

.holo-comment-hover {
    background: rgba(16, 185, 129, 0.12) !important;
    border-color: rgba(16, 185, 129, 0.4) !important;
    box-shadow: 
        0 12px 24px rgba(0, 0, 0, 0.15),
        0 0 30px rgba(16, 185, 129, 0.2),
        inset 0 1px 2px rgba(255, 255, 255, 0.1) !important;
}



/* Mobile optimizations */
@media (max-width: 640px) {
    .holo-comment-shell,
    .holo-comment-new {
        backdrop-filter: blur(10px);
        box-shadow: 
            0 4px 8px rgba(0, 0, 0, 0.1),
            inset 0 1px 2px rgba(255, 255, 255, 0.05);
    }
    
    .holo-comment-hover {
        box-shadow: 
            0 6px 12px rgba(0, 0, 0, 0.1),
            0 0 15px rgba(16, 185, 129, 0.1),
            inset 0 1px 2px rgba(255, 255, 255, 0.1) !important;
    }
}

/* Holographic Comment Avatars */
.holo-comment-avatar {
    border: 2px solid rgba(6, 182, 212, 0.4);
    box-shadow: 
        0 0 15px rgba(6, 182, 212, 0.3),
        inset 0 1px 2px rgba(255, 255, 255, 0.1);
    filter: 
        drop-shadow(0 0 8px rgba(6, 182, 212, 0.2))
        saturate(1.1);
}

.holo-avatar-link:hover .holo-comment-avatar {
    border-color: rgba(16, 185, 129, 0.6);
    box-shadow: 
        0 0 25px rgba(16, 185, 129, 0.5),
        inset 0 1px 2px rgba(255, 255, 255, 0.2);
    filter: 
        drop-shadow(0 0 12px rgba(16, 185, 129, 0.4))
        saturate(1.3);
    transform: scale(1.05);
}

.holo-avatar-link:hover .holo-comment-avatar {
    animation: none;
}

/* Holographic Typography */
.holo-username {
    color: rgba(255, 255, 255, 0.95) !important;
    text-shadow: 0 0 8px rgba(16, 185, 129, 0.4);
    font-weight: 700;
    letter-spacing: 0.5px;
}

.holo-comment-text {
    color: rgba(255, 255, 255, 0.9) !important;
    text-shadow: 0 0 3px rgba(6, 182, 212, 0.2);
    line-height: 1.5;
}

.holo-timestamp {
    color: rgba(255, 255, 255, 0.7) !important;
    background: rgba(0, 0, 0, 0.2) !important;
    padding: 2px 8px !important;
    border-radius: 12px;
    border: 1px solid rgba(6, 182, 212, 0.2);
    backdrop-filter: blur(5px);
    text-shadow: 0 0 5px rgba(6, 182, 212, 0.3);
    font-size: 11px;
}

/* Hover states for better readability */
. .holo-username {
    color: rgba(255, 255, 255, 1) !important;
    text-shadow: 0 0 12px rgba(16, 185, 129, 0.6);
}

.holo-comment-hover .holo-comment-text {
    color: rgba(255, 255, 255, 0.95) !important;
    text-shadow: 0 0 5px rgba(6, 182, 212, 0.3);
}

.holo-comment-hover .holo-timestamp {
    background: rgba(16, 185, 129, 0.1) !important;
    border-color: rgba(16, 185, 129, 0.3);
    color: rgba(255, 255, 255, 0.8) !important;
}


/* Cancel buttons for edit/reply forms */
.btn.link-primary {
    background: rgba(239, 68, 68, 0.1) !important;
    border: 1px solid rgba(239, 68, 68, 0.3) !important;
    color: rgba(247, 70, 70, 0.958) !important;
    padding: 4px 12px !important;
    border-radius: 6px !important;
    backdrop-filter: blur(8px);
    transition: all 0.2s ease !important;
    text-decoration: none !important;
    font-size: 12px;
    font-weight: 500;
}

.btn.link-primary:hover {
    background: rgba(239, 68, 68, 0.15) !important;
    border-color: rgba(239, 68, 68, 0.5) !important;
    color: #ef4444 !important;
    box-shadow: 0 0 15px rgba(239, 68, 68, 0.2) !important;
    text-decoration: none !important;
    transform: scale(1.02);
}

/* Reduced motion preference */
@media (prefers-reduced-motion: reduce) {
    .holo-comment-bubble,
    .holo-comment-hover {
        transition: none;
        transform: none !important;
    }
    
    .holo-comment-bubble::before {
        display: none;
    }
    
    .holo-comment-avatar {
        animation: none;
    }
    
    .holo-avatar-link:hover .holo-comment-avatar {
        transform: none;
    }
}

/* Enhanced Mobile Optimizations */
@media (max-width: 640px) {
    /* Reduce comment padding on mobile */
    .holo-comment-bubble {
        padding: 12px 16px !important;
    }
    
    /* Smaller avatars on mobile */
    .holo-comment-avatar {
        width: 40px !important;
        height: 40px !important;
    }
    
    
    
    /* Simplified hover effects for performance */
    .holo-comment-hover {
        box-shadow: 
            0 6px 12px rgba(0, 0, 0, 0.1),
            0 0 15px rgba(16, 185, 129, 0.1),
            inset 0 1px 2px rgba(255, 255, 255, 0.1) !important;
    }
    
    /* Reduce username and text glow effects */
    .holo-username {
        text-shadow: 0 0 4px rgba(16, 185, 129, 0.3);
    }
    
    .holo-comment-text {
        text-shadow: 0 0 2px rgba(6, 182, 212, 0.2);
    }
}

/* Extra small devices optimization */
@media (max-width: 480px) {
    .holo-comment-bubble {
        padding: 8px 12px !important;
    }
    
    /* Stack action buttons vertically on very small screens */
    .flex.justify-between.mb-1 {
        flex-direction: column;
        gap: 8px;
        align-items: flex-start !important;
    }
    
    
    /* Reduce comment max-width constraint */
    .holo-comment-text {
        max-width: 100% !important;
    }
}

/* High contrast mode support */
@media (prefers-contrast: high) {
    .holo-comment-shell,
    .holo-comment-new {
        border-width: 2px;
        border-color: #00ffff;
    }
    
    .holo-comment-avatar {
        border-width: 3px;
        border-color: #00ff00;
    }
    
    .holo-action-btn {
        border-width: 2px;
        border-color: #00ffff;
    }
    
    .holo-username {
        color: #00ff00 !important;
    }
    
    .holo-comment-text {
        color: #ffffff !important;
    }
}

/* Essential Interactions Only */

/* Edit mode transition */
[x-cloak] { 
    display: none !important; 
}

/* Final Accessibility Enhancements */

/* Focus states for keyboard navigation */
.holo-action-btn:focus,
.holo-comment-submit-btn:focus,
.btn.link-primary:focus {
    outline: 2px solid rgba(16, 185, 129, 0.8) !important;
    outline-offset: 2px;
    box-shadow: 
        0 0 0 4px rgba(16, 185, 129, 0.3),
        0 0 15px rgba(16, 185, 129, 0.4) !important;
}

.holo-comment-textarea:focus {
    outline: 2px solid rgba(16, 185, 129, 0.8) !important;
    outline-offset: 2px;
}

/* Screen reader only text */
.sr-only {
    position: absolute;
    width: 1px;
    height: 1px;
    padding: 0;
    margin: -1px;
    overflow: hidden;
    clip: rect(0, 0, 0, 0);
    white-space: nowrap;
    border: 0;
}

/* Loading/submitting state announcements */
.holo-action-btn[aria-busy="true"]::after {
    content: " Loading...";
    position: absolute;
    left: -9999px;
}

.holo-comment-submit-btn[aria-busy="true"]::after {
    content: " Submitting comment...";
    position: absolute;
    left: -9999px;
}

/* Ensure sufficient color contrast */
@media (prefers-color-scheme: light) {
    .holo-comment-text {
        color: rgba(0, 0, 0, 0.9) !important;
        text-shadow: none !important;
    }
    
    .holo-username {
        color: rgba(0, 0, 0, 0.95) !important;
        text-shadow: none !important;
    }
    
    .holo-comment-shell,
    .holo-comment-new {
        background: rgba(255, 255, 255, 0.9);
        color: rgba(0, 0, 0, 0.9);
    }
}

/* Skip animation on first page load to improve perceived performance */
.no-transitions * {
    transition: none !important;
    animation: none !important;
}

/* Print styles */
@media print {
    .holo-comment-shell,
    .holo-comment-new {
        background: white !important;
        border: 1px solid #ccc !important;
        box-shadow: none !important;
        backdrop-filter: none !important;
    }
    
    .holo-action-btn,
    .holo-comment-submit-btn {
        display: none !important;
    }
    
    .holo-comment-text,
    .holo-username {
        color: black !important;
        text-shadow: none !important;
    }
}

/* GPU acceleration cleanup for low-end devices */
@media (max-width: 480px) {
    .holo-comment-bubble,
    .holo-action-btn,
    .holo-comment-avatar {
        will-change: auto;
    }
}

/* Ensure animations respect system preferences */
@media (prefers-reduced-motion: reduce) {
    *,
    *::before,
    *::after {
        animation-duration: 0.01ms !important;
        animation-iteration-count: 1 !important;
        transition-duration: 0.01ms !important;
    }
}
</style>
