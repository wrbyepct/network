{% extends 'network/layout.html' %}
{% load widget_tweaks %}
{% block body %}

<div class="min-h-screen bg-[#A8D5A0] p-4 font-mono" 
     x-data="albumEditor()"
     style="background-image: url('data:image/svg+xml,%3Csvg width=&quot;100&quot; height=&quot;20&quot; viewBox=&quot;0 0 100 20&quot; xmlns=&quot;http://www.w3.org/2000/svg&quot;%3E%3Cpath d=&quot;M20 20v-4h4v4h-4zm20 0v-4h4v4h-4zm20 0v-4h4v4h-4zm20 0v-4h4v4h-4zm20 0v-4h4v4h-4zM0 16v-4h4v4H0zm20 0v-4h4v4h-4zm20 0v-4h4v4h-4zm20 0v-4h4v4h-4zm20 0v-4h4v4h-4zM0 12v-4h4v4H0zm20 0v-4h4v4h-4zm20 0v-4h4v4h-4zm20 0v-4h4v4h-4zm20 0v-4h4v4h-4zM0 8v-4h4v4H0zm20 0v-4h4v4h-4zm20 0v-4h4v4h-4zm20 0v-4h4v4h-4zm20 0v-4h4v4h-4zM0 4V0h4v4H0zm20 0V0h4v4h-4zm20 0V0h4v4h-4zm20 0V0h4v4h-4zm20 0V0h4v4h-4z&quot; fill=&quot;%23D2B48C&quot; fill-opacity=&quot;0.4&quot; fill-rule=&quot;evenodd&quot;/%3E%3C/svg%3E');">
  


  <!-- Main Container -->
  <div class="max-w-7xl mx-auto">
    <form 
      class="relative"
      method="post" 
      action="{% url 'album_edit' album.pk %}" 
      enctype="multipart/form-data" class="relative z-10"
      x-ref="albumEditForm"
      @submit.prevent="handleSubmit($el)">
      {% csrf_token %}
      <!-- Two Column Layout -->
      <div class="grid grid-cols-1 lg:grid-cols-6 gap-8">
        <!-- LEFT COLUMN: Current Photos -->
        <div class="lg:col-span-4 order-1 lg:order-1">
          <!-- Selection Controls -->
          <div class="bg-[#2E7D32] border-4 border-[#1B5E20] p-4 mb-6 shadow-[8px_8px_0px_#3B3B3B] relative">
            <div class="flex justify-between items-center">
              <!-- Select All Checkbox -->
              <div class="flex items-center gap-3">
                <div class="relative">
                  <input type="checkbox" 
                        id="select-all"
                        x-model="selectAll"
                        @change="toggleSelectAll()"
                        class="w-5 h-5 bg-[#A5D6A7] border-2 border-[#4CAF50] rounded focus:ring-2 focus:ring-[#FBBF24]">
                </div>
                <label for="select-all" class="text-[#A5D6A7] font-bold font-mono text-sm sm:text-base">SELECT ALL PHOTOS</label>
              </div>

              <!-- Selection Counter and Actions -->
              <div class="flex items-center gap-4">
                <span class="text-[#FBBF24] font-mono text-sm" x-text="`${selectedMedias.length} selected`"></span>
                <button type="submit"
                        x-show="selectedMedias.length > 0"
                        x-cloak
                        class="bg-[#FF5722] hover:bg-[#F44336] border-2 border-[#3B3B3B] text-white font-mono text-xs py-1 px-3 rounded transition-colors">
                  üóëÔ∏è Delete Selected
                </button>
              </div>
            </div>
          </div>

          <!-- Current Photos Grid -->
          <div class="bg-[#A5D6A7] border-4 border-[#5D4037] rounded-lg p-4 shadow-[8px_8px_0px_#3B3B3B] relative">
            <!-- Grass pattern background -->
            <div class="absolute inset-0 opacity-20 rounded" style="background: repeating-linear-gradient(0deg, transparent 0px, transparent 2px, #4CAF50 2px, #4CAF50 3px);"></div>
            
            <div class="relative z-10">
              <!-- Photos Grid -->
              <div class="grid grid-cols-2 lg:grid-cols-3 gap-2 lg:gap-4">
                {% for media in medias %}
                  <div class="relative group">
                    <!-- Checkbox -->
                    <div class="absolute top-2 right-2 z-20">
                      <input type="checkbox" 
                            name="delete_media" 
                            value="{{ media.id }}"
                            x-model="selectedMedias"
                            class="w-4 h-4 sm:w-5 sm:h-5 bg-[#A5D6A7] border-2 border-[#4CAF50] rounded focus:ring-2 focus:ring-[#FBBF24] shadow-lg">
                    </div>
                    
                    <!-- Image/Video Preview -->
                    <div class="aspect-square bg-[#C8E6C9] border-4 border-[#2E7D32] rounded overflow-hidden shadow-[4px_4px_0px_#3B3B3B] hover:shadow-[6px_6px_0px_#3B3B3B] transition-all duration-200"
                        :class="selectedMedias.includes('{{ media.id }}') ? 'ring-4 ring-[#FBBF24]' : ''">
                      {% if media.is_image %}
                        <img src="{{ media.file.url }}" 
                            alt="Turtle Photo"
                            class="w-full h-full object-cover hover:scale-105 transition-transform duration-200">
                      {% elif media.is_video %}
                        <video class="w-full h-full object-cover">
                          <source src="{{ media.file.url }}">
                        </video>
                        <!-- Video Play Overlay -->
                        <div class="absolute inset-0 flex items-center justify-center bg-black bg-opacity-50">
                          <div class="w-8 h-8 bg-[#FFD66F] border-2 border-[#5D4037] rounded-full flex items-center justify-center">
                            <div class="w-0 h-0 border-l-4 border-l-[#5D4037] border-y-2 border-y-transparent ml-1"></div>
                          </div>
                        </div>
                      {% endif %}
                    </div>
                    
                    <!-- Media Info -->
                    <div class="absolute bottom-0 left-0 right-0 bg-[#2E7D32] bg-opacity-90 text-[#A5D6A7] text-xs p-1 sm:p-2 font-mono">
                      <div class="truncate">{{ media.file.name }}</div>
                      <div class="text-[#8BC34A]">{{ media.file.size|filesizeformat }}</div>
                    </div>
                  </div>
                {% empty %}
                  <div class="col-span-full text-center py-12">
                    <div class="w-16 h-16 bg-[#C8E6C9] border-4 border-[#4CAF50] rounded mx-auto mb-4 flex items-center justify-center">
                      <div class="text-[#4CAF50] text-2xl">üê¢</div>
                    </div>
                    <p class="text-[#4CAF50] font-mono text-sm">No turtle photos in this album yet</p>
                  </div>
                {% endfor %}
              </div>
            </div>
          </div>
          
        </div>
      <!-- END LEFT COLUMN -->

        <!-- RIGHT COLUMN: Edit Form -->
        <div class="lg:col-span-2 order-2 lg:order-2 space-y-6">
          
          <!-- Edit Form Header -->
          <div class="bg-[#8B4513] border-4 border-[#5D4037] rounded-lg p-4 text-center shadow-[12px_12px_0px_#3B3B3B] relative overflow-hidden">
            <!-- Wooden grain pattern -->
            <div class="absolute inset-0 opacity-20" style="background: repeating-linear-gradient(90deg, #6F4E37 0px, transparent 1px, transparent 4px, #6F4E37 5px);"></div>
            
            <!-- Form Icon -->
            <div class="mb-3 relative z-10">
              <div class="w-12 h-12 bg-[#4CAF50] border-4 border-[#3B3B3B] relative turtle-shell mx-auto hover:scale-105 transition-transform duration-200">
                <div class="absolute inset-2 bg-[#2E7D32] border-2 border-[#1B5E20] flex items-center justify-center">
                  <!-- Settings icon -->
                  <div class="w-6 h-6 border-2 border-[#A5D6A7] rounded relative">
                    <div class="absolute top-1 left-1 w-1 h-1 bg-[#A5D6A7]"></div>
                    <div class="absolute top-1 right-1 w-1 h-1 bg-[#A5D6A7]"></div>
                    <div class="absolute bottom-1 left-1 w-1 h-1 bg-[#A5D6A7]"></div>
                    <div class="absolute bottom-1 right-1 w-1 h-1 bg-[#A5D6A7]"></div>
                  </div>
                </div>
              </div>
            </div>
            
            <h2 class="text-lg font-bold text-[#FFD66F] mb-1 pixel-title relative z-10" style="text-shadow: 2px 2px #3B3B3B;">ALBUM SETTINGS</h2>
            <p class="text-[#D2B48C] text-sm relative z-10">Update your collection</p>
          </div>

          <!-- Right form Container -->
          <div class="bg-[#FFD66F] border-4 border-[#5D4037] rounded-lg p-6 shadow-[8px_8px_0px_#3B3B3B] relative">
            <!-- Grass pattern background -->
           <div class="absolute inset-0 opacity-30 -z-100" style="background: repeating-linear-gradient(0deg, transparent 0px, transparent 2px, #4CAF50 2px, #4CAF50 3px);"></div>
        
            <!-- Album Name Field -->
            <div class="mb-6">
              <div class="flex items-center gap-3 mb-4">
                <div class="w-4 h-4 bg-[#4CAF50] border-2 border-[#3B3B3B] shell-dot"></div>
                <label for="{{ form.name.id_for_label }}" class="text-sm sm:text-base font-bold text-[#5D4037] font-mono pixel-title">ALBUM NAME</label>
              </div>
              
              <div class="bg-[#A5D6A7] border-4 border-[#5D4037] rounded p-2 shadow-[4px_4px_0px_#3B3B3B]">
                <input type="text" 
                       name="name" 
                       id="{{ form.name.id_for_label }}"
                       class="w-full bg-[#C8E6C9] border-2 border-[#2E7D32] rounded px-4 py-3 text-[#1B5E20] font-mono font-bold placeholder-[#4CAF50] focus:border-[#FBBF24] focus:outline-none transition-colors"
                       placeholder="Enter album name..."
                       value="{{ form.name.value|default_if_none:'' }}">
              </div>
              {% if form.name.errors %}
                <div class="mt-2 text-[#8B4513] text-sm font-bold bg-[#D2B48C] border-2 border-[#5D4037] p-2 rounded">
                  üê¢ {{ form.name.errors }}
                </div>
              {% endif %}
            </div>

            <!-- Add More Photos Field -->
            <div class="mb-6">
              <div class="flex items-center gap-3 mb-4">
                <div class="w-4 h-4 bg-[#FBBF24] border-2 border-[#3B3B3B] shell-dot pixel-blink"></div>
                <label for="{{ form.medias.id_for_label }}" class="text-sm sm:text-base font-bold text-[#5D4037] font-mono pixel-title">ADD MORE PHOTOS</label>
              </div>
              
              <div class="text-center">
                <button type="button"
                        @click="$refs.fileInput.click()"
                        class="bg-[#8BC34A] hover:bg-[#AED581] border-4 border-[#5D4037] text-[#2E7D32] font-mono font-bold py-2 px-4 sm:py-3 sm:px-6 rounded text-xs sm:text-sm transition-colors shadow-[4px_4px_0px_#3B3B3B] game-button">
                  üê¢ ADD TURTLE PHOTOS
                </button>
                
                <input type="file" 
                       accept="image/*" 
                       name="medias" 
                       id="{{ form.medias.id_for_label }}"
                       multiple 
                       class="hidden"
                       x-ref="fileInput"
                       @change="handleFileUpload($event)"
                      >
              </div>
              
              {% if form.medias.errors %}
                <div class="mt-4 text-[#8B4513] text-sm font-bold bg-[#D2B48C] border-2 border-[#5D4037] p-3 rounded">
                  üö´ {{ form.medias.errors }}
                </div>
              {% endif %}
            </div>

            <!-- Action Buttons -->
            <div class="space-y-4">
              <!-- Update Button -->
              <button type="submit" 
                      class="w-full bg-[#FBBF24] hover:bg-[#FFE082] active:bg-[#F57C00] border-4 border-[#5D4037] hover:border-[#3B3B3B] text-[#2E7D32] font-mono font-bold py-3 px-6 rounded-lg text-sm sm:text-base transition-all duration-200 transform hover:scale-105 active:scale-95 shadow-[8px_8px_0px_#3B3B3B] game-button"
                      :disabled="isSubmitting"
                      x-text="isSubmitting ? 'üê¢ UPDATING ALBUM...' : 'üíæ UPDATE ALBUM'">
              </button>
              
              <!-- Delete Album Button -->
              <button type="button" 
                      @click="confirmDeleteAlbum()"
                      class="w-full bg-[#FF5722] hover:bg-[#F44336] border-4 border-[#5D4037] text-white font-mono font-bold py-3 px-6 rounded-lg text-sm sm:text-base transition-all duration-200 shadow-[6px_6px_0px_#3B3B3B] game-button">
                üóëÔ∏è DELETE ENTIRE ALBUM
              </button>
            </div>
          </div>
        </div>
        <!-- END RIGHT COLUMN -->
      </div>

      <!-- NEW UPLOAD MEDIA MODAL -->
       <template x-if="newUploadMedias.length > 0">
          <div class="absolute inset-0 backdrop-blur-sm flex items-center justify-center">

            <template x-for="(media, index) in newUploadMedias" :key="index">
              <!-- Individual media container -->
              <div>
                <template x-if="media.file_type === 'image'">
                  <img class="object-cover" :src="media.url" alt="New user uploaded image">
                </template>
                <template x-if="media.file_type === 'video'">
                  <video class="object-cover" :src="media.url" preload="metadata">

                  </video>
                </template>
              </div>
            </template>

            <!-- New Upload Display container -->
            <div class="grid grid-cols-2 lg:grid-cols-3">
              <!-- Add more button -->
              <button 
                type="button" 
                class="col-span-1 flex items-center justify-center"
                @click="$refs.fileInput.click()"
              >
                <span class="text-xlg">+</span>
                
              </button>
            </div>
          </div>
       </template>


    </form>
    <!-- END TWO COLUMN LAYOUT -->
  </div>
  <!-- END MAIN CONTAINER -->

  <!-- Hidden form for album deletion -->
  <form method="post" action="{% url 'album_delete' album.id %}" id="album-delete-form" class="hidden">
    {% csrf_token %}
  </form>


<script>
  function albumEditor() {
    return {
      newUploadMedias: [],
      selectedMedias: [],
      selectAll: false,
      isSubmitting: false,
      totalPhotos: {{ medias|length }},

      handleFileUpload(evt) {
        const files = Array.from(evt.target.files)
        const mediaFiles = files.filter(file => { return file.startsWith('image/') || file.startsWith('video/') }).slice(0, 10);
        this.createPreviewMedias(mediaFiles);
      },
      createPreviewMedias(files) {
        this.newUploadMedias = [];
        files.forEach(file => {
          const reader = new FileReader();
          reader.onload = (e) => {
            this.newUploadMedias.push(
              {
                url: e.target.result,
                file: file,
                file_type: file.type.startsWith('image/') ? 'image' : 'video',
              }
            )
          }
          reader.readAsDataURL(file);
        });
      },
      toggleSelectAll() {
        if (this.selectAll) {
          // Select all media IDs
          this.selectedMedias = [{% for media in medias %}'{{ media.id }}'{% if not forloop.last %},{% endif %}{% endfor %}];
        } else {
          // Deselect all
          this.selectedMedias = [];
        }
      },
      confirmDeleteAlbum() {
        if (confirm('üö® Are you absolutely sure you want to delete this entire turtle album? This action cannot be undone!')) {
          this.$refs.albumEditForm.submit();
        }
      },

      handleSubmit(form) {
        this.isSubmitting = true;
        if (this.newUploadMedias.length > 0) {

          const dt = new DataTransfer();

          this.newUploadMedias.forEach(file => dt.items.add(file))
          this.refs.fileInput.files = dt.files
        }
      
        form.submit();
      },

      // Watch for individual checkbox changes to update selectAll
      init() {
        this.$watch('selectedMedias', () => {
          const totalMedias = {{ medias|length }};
          this.selectAll = this.selectedMedias.length === totalMedias && totalMedias > 0;
        });
      }
    }
  }
</script>

<style>
  /* Turtle shell rotate animation */
  .shell-spin {
    animation: shell-rotate 4s linear infinite;
  }

  @keyframes shell-rotate {
    0% { transform: rotateY(0deg); }
    25% { transform: rotateY(90deg) scaleX(0.8); }
    50% { transform: rotateY(180deg); }
    75% { transform: rotateY(270deg) scaleX(0.8); }
    100% { transform: rotateY(360deg); }
  }

  /* Pixel blink animation */
  .pixel-blink {
    animation: turtle-blink 2s infinite;
  }

  @keyframes turtle-blink {
    0%, 85%, 100% { opacity: 1; }
    90%, 95% { opacity: 0.3; }
  }



  /* Game button effects - Turtle theme */
  .game-button:hover:not(.pressed) {
    transform: translate(-2px, -2px);
    box-shadow: 8px 8px 0px #5D4037 !important;
  }

  .game-button.pressed {
    transform: translate(4px, 4px);
    box-shadow: 2px 2px 0px #5D4037 !important;
  }

  /* Pixel title styling */
  .pixel-title {
    letter-spacing: 0.1em;
    image-rendering: pixelated;
    image-rendering: -moz-crisp-edges;
    image-rendering: -webkit-crisp-edges;
    image-rendering: crisp-edges;
  }

  /* Shell segment animation */
  .shell-segment {
    animation: segment-glow 3s ease-in-out infinite;
  }

  @keyframes segment-glow {
    0%, 100% { background-color: #A5D6A7; }
    50% { background-color: #C8E6C9; }
  }

  /* Turtle hover animation */
  .turtle-shell:hover {
    animation: turtle-bounce 0.6s ease-in-out;
  }

  @keyframes turtle-bounce {
    0%, 100% { transform: translateY(0px); }
    50% { transform: translateY(-8px); }
  }

  /* Shell dot pulse */
  .shell-dot {
    animation: shell-pulse 2s ease-in-out infinite;
  }

  @keyframes shell-pulse {
    0%, 100% { transform: scale(1); opacity: 1; }
    50% { transform: scale(1.1); opacity: 0.8; }
  }

  /* Responsive turtle shell sizes using Tailwind-like approach */
  @media (max-width: 1024px) {
    .turtle-shell {
      width: 3.5rem;
      height: 3.5rem;
    }
  }

  @media (max-width: 640px) {
    .turtle-shell {
      width: 3rem;
      height: 3rem;
    }
  }
</style>

{% endblock %}
